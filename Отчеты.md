# Отчеты по системе токенов и гостевого режима

## Гостевой режим

Гостевой режим позволяет пользователям получить временный доступ к системе без полной регистрации. Это полезно для ознакомления с функционалом платформы перед созданием полноценного аккаунта.

### Как работает гостевой режим

1. **Генерация гостевого токена**: При входе в гостевой режим система генерирует уникальный временный токен.
2. **Ограниченный доступ**: Гости имеют доступ только к базовому функционалу.
3. **Временные ограничения**: Гостевые сессии имеют ограниченное время жизни.
4. **Возможность конвертации**: Гости могут в любой момент зарегистрироваться и сохранить свой прогресс.

### Файлы, связанные с гостевым режимом

#### 1. [`back-end/server.js`](back-end/server.js)

Содержит основную логику обработки гостевых токенов:

- **Генерация гостевого токена** (строка ~150-170):
```javascript
// Генерация гостевого токена
app.post('/api/guest-token', async (req, res) => {
  try {
    const guestToken = generateGuestToken()
    const expiresIn = '24h' // Время жизни гостевого токена
    
    // Сохранение токена в базе данных или кэше
    await saveGuestToken(guestToken, expiresIn)
    
    res.json({
      token: guestToken,
      expiresIn: expiresIn,
      userType: 'guest'
    })
  } catch (error) {
    console.error('Error generating guest token:', error)
    res.status(500).json({ error: 'Failed to generate guest token' })
  }
})
```

- **Проверка гостевого токена** (строка ~200-220):
```javascript
// Middleware для проверки гостевого токена
const verifyGuestToken = async (req, res, next) => {
  const token = req.headers['authorization']?.split(' ')[1]
  
  if (!token) {
    return res.status(401).json({ error: 'No token provided' })
  }
  
  try {
    const isValid = await checkGuestToken(token)
    
    if (!isValid) {
      return res.status(401).json({ error: 'Invalid or expired guest token' })
    }
    
    req.userType = 'guest'
    next()
  } catch (error) {
    console.error('Error verifying guest token:', error)
    res.status(401).json({ error: 'Invalid token' })
  }
}
```

#### 2. [`src/components/AuthManager.jsx`](src/components/AuthManager.jsx)

Управляет состоянием аутентификации на фронтенде:

- **Хранение токена**: Сохраняет гостевой токен в localStorage
- **Проверка статуса**: Определяет, является ли пользователь гостем
- **Ограничение доступа**: Контролирует доступ к функциям в зависимости от типа пользователя

#### 3. [`src/config/api.js`](src/config/api.js)

Содержит конфигурацию API endpoints для работы с гостевым режимом:

```javascript
export const API_ENDPOINTS = {
  // ... другие endpoints
  guestToken: `${API_BASE_URL}/api/guest-token`,
  verifyGuest: `${API_BASE_URL}/api/verify-guest`,
  upgradeGuest: `${API_BASE_URL}/api/upgrade-guest`
}
```

### Типы токенов

1. **Гостевой токен (Guest Token)**
   - Временный токен с ограниченным сроком действия
   - Предоставляет доступ только к базовому функционалу
   - Не требует регистрации
   - Имеет ограниченное время жизни (обычно 24 часа)

2. **Пользовательский токен (User Token)**
   - Постоянный токен для зарегистрированных пользователей
   - Предоставляет полный доступ к системе
   - Требует регистрации и аутентификации
   - Может быть отозван или обновлен

3. **Администраторский токен (Admin Token)**
   - Токен с расширенными правами
   - Предоставляет доступ к административным функциям
   - Требует специальной аутентификации

### Процесс аутентификации

1. **Гостевой вход**:
   - Пользователь выбирает "Войти как гость"
   - Система генерирует гостевой токен
   - Токен сохраняется в localStorage
   - Пользователь получает ограниченный доступ

2. **Регистрация из гостевого режима**:
   - Гость решает зарегистрироваться
   - Система предлагает сохранить прогресс
   - После регистрации гостевой токен конвертируется в пользовательский
   - Все данные гостя переносятся на новый аккаунт

3. **Обычная регистрация**:
   - Пользователь проходит полную регистрацию
   - Система создает пользовательский токен
   - Предоставляется полный доступ к системе

### Безопасность

- Гостевые токены имеют короткое время жизни
- Все токены хранятся в защищенном HTTP-only куки (на сервере)
- Используется CSRF защита для всех операций
- Чувствительные операции требуют дополнительной аутентификации

### Примеры использования

```javascript
// Получение гостевого токена
const response = await fetch(API_ENDPOINTS.guestToken, {
  method: 'POST'
})
const { token } = await response.json()

// Использование токена в запросах
const userResponse = await fetch(API_ENDPOINTS.userData, {
  headers: {
    'Authorization': `Bearer ${token}`
  }
})
```

### Ограничения гостевого режима

1. **Функциональные ограничения**:
   - Нет доступа к персональным данным
   - Ограниченное количество действий в день
   - Нет возможности сохранять прогресс на долгое время
   - Ограниченный доступ к премиум-контенту

2. **Технические ограничения**:
   - Сессия автоматически завершается через 24 часа
   - Данные гостя могут быть удалены при очистке кэша
   - Нет возможности восстановить доступ к гостевой сессии

### Конвертация гостя в пользователя

Процесс конвертации позволяет гостю сохранить свой прогресс при регистрации:

1. Гость нажимает "Зарегистрироваться"
2. Система сохраняет текущий прогресс гостя
3. Гость проходит процесс регистрации
4. После успешной регистрации прогресс гостя переносится на новый аккаунт
5. Гостевой токен заменяется на пользовательский токен

### Лучшие практики

1. **Для разработчиков**:
   - Всегда проверяйте тип токена перед выполнением операций
   - Используйте middleware для проверки прав доступа
   - Обеспечивайте плавный переход из гостевого режима в пользовательский

2. **Для пользователей**:
   - Регулярно сохраняйте важные данные
   - Регистрируйтесь, чтобы сохранить прогресс
   - Будьте осторожны с конфиденциальной информацией в гостевом режиме

### Заключение

Гостевой режим предоставляет удобный способ ознакомиться с системой без обязательной регистрации. Однако для полноценного использования всех функций рекомендуется создать постоянный аккаунт. Система токенов обеспечивает безопасность и гибкость в управлении доступом пользователей.
