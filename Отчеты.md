

< --------------------------- –†–ï–®–ï–ù–ò–ï --------------------------- >
# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫ CSP –∏ MIME-–±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 1. **CSP-–ø–æ–ª–∏—Ç–∏–∫–∞ —Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–∞—è** (`server.js`)

```javascript
res.setHeader("Content-Security-Policy", 
  "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self';");
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå `script-src 'self'` –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã React
- ‚ùå –ù–µ—Ç `blob:` –¥–ª—è Workers –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
- ‚ùå –ù–µ—Ç `wasm-unsafe-eval` –¥–ª—è WebAssembly (@xenova/transformers)
- ‚ùå `style-src` —Ç–æ–ª—å–∫–æ `'self'` ‚Äî –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Å—Ç–∏–ª–∏ –æ—Ç Tailwind

### 2. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –º–µ–∂–¥—É `_headers` –∏ `server.js`**

`_headers` (Netlify) –ø—É—Å—Ç/–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π:
```
/* (–ø—É—Å—Ç–æ!)
/assets/*.js
  Content-Type: application/javascript
```

- ‚ùå –ù–µ—Ç CSP –≤ `_headers` ‚Üí –ø—Ä–∏ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–∏ –Ω–∞ Netlify –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- ‚ùå `server.js` —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ
- ‚ö†Ô∏è –ù–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ (GitHub Pages) CSP –≤–æ–æ–±—â–µ –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è

### 3. **MIME-—Ç–∏–ø—ã –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ**

`serve.js` –Ω–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç MIME-—Ç–∏–ø—ã:
```javascript
app.use('/Alphearea', express.static(...)); // –ë–µ–∑ —è–≤–Ω–æ–≥–æ MIME
```

- ‚ùå Vite-–±–∞–Ω–¥–ª—ã (`.js.gz`) –º–æ–≥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∫–∞–∫ `text/plain`
- ‚ùå CSS –º–æ–≥—É—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ non-CSS
- ‚ùå –°–∂–∞—Ç—ã–µ —Ñ–∞–π–ª—ã (gzip) –Ω–µ –¥–µklara—Ç—å—Å—è

---

## üìã –†–ï–®–ï–ù–ò–Ø

### **–®–ê–ì 1: –û–±–Ω–æ–≤–∏—Ç—å CSP –≤ `server.js`**

```javascript
app.use((req, res, next) => {
  res.setHeader("Content-Security-Policy", 
    "default-src 'self'; " +
    "script-src 'self' 'wasm-unsafe-eval' blob:; " +
    "style-src 'self' 'unsafe-inline' blob:; " +
    "img-src 'self' data: blob:; " +
    "font-src 'self' data: blob:; " +
    "worker-src blob: 'self'; " +
    "connect-src 'self' http://localhost:3002; " +
    "frame-src 'none'; " +
    "object-src 'none';");
  
  res.setHeader("X-Content-Type-Options", "nosniff");
  res.setHeader("X-Frame-Options", "DENY");
  res.setHeader("Referrer-Policy", "strict-origin-when-cross-origin");
  next();
});
```

**–ö–ª—é—á–µ–≤—ã–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:**
- `'wasm-unsafe-eval'` ‚Äî –¥–ª—è @xenova/transformers
- `blob:` ‚Äî –¥–ª—è Workers –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
- `worker-src` ‚Äî —è–≤–Ω–æ —Ä–∞–∑—Ä–µ—à–∞–µ–º web workers
- `connect-src` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω localhost:3002 (backend)

---

### **–®–ê–ì 2: –û–±–Ω–æ–≤–∏—Ç—å MIME –≤ `serve.js`**

```javascript
import mime from 'mime';

app.use((req, res, next) => {
  // –Ø–≤–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º MIME –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤
  if (req.url.endsWith('.js') || req.url.endsWith('.js.gz')) {
    res.setHeader('Content-Type', 'application/javascript');
  } else if (req.url.endsWith('.css') || req.url.endsWith('.css.gz')) {
    res.setHeader('Content-Type', 'text/css; charset=utf-8');
  } else if (req.url.endsWith('.wasm')) {
    res.setHeader('Content-Type', 'application/wasm');
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º Content-Encoding –¥–ª—è gzip
  if (req.url.endsWith('.gz')) {
    res.setHeader('Content-Encoding', 'gzip');
  }
  
  next();
});

app.use('/Alphearea', express.static(path.join(__dirname, 'dist')));
```

**–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –≥–æ—Ç–æ–≤—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É:**
```javascript
import mime from 'mime';
import compression from 'compression';

app.use(compression()); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π gzip
app.use('/Alphearea', express.static(path.join(__dirname, 'dist'), {
  setHeaders: (res, path) => {
    if (path.endsWith('.wasm')) {
      res.setHeader('Content-Type', 'application/wasm');
    }
    if (path.endsWith('.gz')) {
      res.setHeader('Content-Encoding', 'gzip');
    }
  }
}));
```

---

### **–®–ê–ì 3: –û–±–Ω–æ–≤–∏—Ç—å `_headers` –¥–ª—è Netlify/GitHub Pages**

```
# _headers
/*
  Content-Security-Policy: default-src 'self'; script-src 'self' 'wasm-unsafe-eval' blob:; style-src 'self' 'unsafe-inline' blob:; img-src 'self' data: blob:; font-src 'self' data: blob:; worker-src blob: 'self'; connect-src 'self' https://api.example.com; frame-src 'none'; object-src 'none'
  X-Content-Type-Options: nosniff
  X-Frame-Options: DENY
  Referrer-Policy: strict-origin-when-cross-origin

/assets/*.js
  Content-Type: application/javascript
  Cache-Control: public, max-age=31536000, immutable

/assets/*.css
  Content-Type: text/css; charset=utf-8
  Cache-Control: public, max-age=31536000, immutable

/assets/*.wasm
  Content-Type: application/wasm
  Cache-Control: public, max-age=31536000, immutable

/*.js.gz
  Content-Type: application/javascript
  Content-Encoding: gzip

/*.css.gz
  Content-Type: text/css; charset=utf-8
  Content-Encoding: gzip
```

---

### **–®–ê–ì 4: –û–±–Ω–æ–≤–∏—Ç—å `vite.config.js` –¥–ª—è SPA**

```javascript
// vite.config.js
export default defineConfig(({ mode }) => ({
  // ... –æ—Å—Ç–∞–ª—å–Ω–æ–µ ...
  server: {
    historyApiFallback: true,
    headers: {
      'Content-Security-Policy': "default-src 'self'; script-src 'self' 'wasm-unsafe-eval' blob:; style-src 'self' 'unsafe-inline' blob:; img-src 'self' data: blob:; font-src 'self' data: blob:; worker-src blob: 'self'; connect-src 'self' http://localhost:* ws://localhost:*; frame-src 'none'; object-src 'none'",
    },
    proxy: {
      '/api': {
        target: 'http://localhost:3002',
        changeOrigin: true,
        secure: false,
      },
    },
  },
  build: {
    sourcemap: false,
    minify: 'terser',
    rollupOptions: {
      output: {
        // –Ø–≤–Ω–æ –Ω–∞–∑—ã–≤–∞–µ–º —á–∞–Ω–∫–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è MIME
        manualChunks: {
          vendor: ['react', 'react-dom'],
          router: ['react-router-dom'],
          transformers: ['@xenova/transformers'], // –û—Ç–¥–µ–ª—å–Ω—ã–π —á–∞–Ω–∫ –¥–ª—è WASM
        }
      }
    }
  }
}))
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –ü—Ä–æ–≤–µ—Ä–∫–∞ CSP –≤ –±—Ä–∞—É–∑–µ—Ä–µ:
```javascript
// –ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞
document.head.querySelector('meta[http-equiv="Content-Security-Policy"]')
// –∏–ª–∏
fetch('/api/check-headers').then(r => r.headers.forEach((v,k) => console.log(k, v)))
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ MIME:
```bash
# Terminal
curl -I http://localhost:3000/Alphearea/assets/index-abc123.js
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: Content-Type: application/javascript

curl -I http://localhost:3000/Alphearea/assets/index-abc123.css
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: Content-Type: text/css; charset=utf-8
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ CSP –Ω–∞—Ä—É—à–µ–Ω–∏–π:
```javascript
// index.html
<script>
  window.addEventListener('securitypolicyviolation', (e) => {
    console.error('CSP Violation:', {
      blockedURI: e.blockedURI,
      violatedDirective: e.violatedDirective,
      originalPolicy: e.originalPolicy
    });
  });
</script>
```

---

## üì¶ –£–°–¢–ê–ù–û–í–ò–¢–¨ –ó–ê–í–ò–°–ò–ú–û–°–¢–ò

```bash
# –î–ª—è serve.js
npm install mime compression --save

# –î–ª—è backend
cd back-end
npm install mime compression --save
```

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û: GitHub Pages

GitHub Pages –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏. –ò—Å–ø–æ–ª—å–∑—É–π:

1. **Cloudflare Pages** (–ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `_headers`)
2. **Netlify** (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `_headers`)
3. **Vercel** (–∏—Å–ø–æ–ª—å–∑—É–π `vercel.json` –≤–º–µ—Å—Ç–æ `_headers`)

–î–ª—è Vercel —Å–æ–∑–¥–∞–π `vercel.json`:
```json
{
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "Content-Security-Policy",
          "value": "default-src 'self'; script-src 'self' 'wasm-unsafe-eval' blob:; ..."
        }
      ]
    }
  ]
}
```

---

## üéØ –ß–ï–ö–õ–ò–°–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

- [ ] –û–±–Ω–æ–≤–∏—Ç—å CSP –≤ `server.js`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å MIME –≤ `serve.js`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `_headers` –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `vite.config.js`
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (`mime`, `compression`)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ (`npm run dev`)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ CSP –æ—à–∏–±–∫–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Network tab –Ω–∞ MIME —Ç–∏–ø—ã
- [ ] –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ